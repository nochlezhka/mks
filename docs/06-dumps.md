## Регулярное копирование БД и статических данных.

Для сохранности данных в базе данных и статического контента (фотографий и документов клиентов) у нас настроено регулярное копирование сначала с локальную директорию (/opt/storage/backup/crm.homeless.ru/), а потом на удаленный сервер (ci.homeless.ru:/home/homeless/backup/crm.homeless.ru/).

Задачи по расписанию выполняются в [Jenkins'е](https://ci.homeless.ru/). Конфгурации для сборок хранятся в отдельном [репозитории](https://github.com/nochlezhka/configs).


## Восстановление из резервной копии

Если возникли проблемы с базой данных, необходимо в mysql выгрузить последний дамп БД:

    > mysql MYSQL_DATABASE -uMYSQL_USER -pMYSQL_PASSWORD -h127.0.0.1 --port MYSQL_PORT < dump.sql
    > Параметры MYSQL_DATABASE, MYSQL_USER, MYSQL_PASSWORD, MYSQL_PORT необходимо поменять не те, которые указаны в файле, а dump.sql - на имя файла с последним дампом базы данных

и пройти все шаги начиная 9 (см. [документацию](05-update.md) по обновлению)


Если не хватает каких-то данных (фотографий, документов) или к ним нет доступа, необходимо проверить, что на директорию со статическими данными `shared/homeless/web/uploads/` выставлены правильные права:

    > сhown -R homeless:homeless /opt/storage/crm.homeless.ru/mks_private/shared/homeless/web/uploads/

Если после этого не хватает каких-либо файлов, необходимо скопировать их из директории, в которую регулярно сохраняются копии статических данных.



## Защита данных

Так как мы используем МКС на сервере, который имеет прямой доступ в интернет, у нас на web-сервере настроено огранчение доступа - [basic-авторизацию](https://nginx.org/ru/docs/http/ngx_http_auth_basic_module.html).
А чтобы сотрудникам не приходилось каждый раз 2 раза авторизовываться, включена настроийка, чтобы с доверенных IP-адресов (например, из офиса), Nginx не требовал basic-авторизацию: директива [satisfy](http://nginx.org/ru/docs/http/ngx_http_core_module.html#satisfy).

