---
- hosts: all
  become: true
  vars:
    docker_install_compose_plugin: true
    docker_edition: 'ce'
    docker_packages_state: present
    docker_apt_release_channel: stable
    docker_users:
      - ubuntu
    docker_packages:
      - "docker-{{ docker_edition }}"
      - "docker-{{ docker_edition }}-cli"
      - "docker-{{ docker_edition }}-rootless-extras"
    docker_service_manage: true
    docker_service_state: started
    docker_service_enabled: true
    docker_restart_handler_state: restarted
  pre_tasks:
    - name: Update apt-get repo and cache
      apt: update_cache=yes force_apt_get=yes cache_valid_time=3600
  roles:
    # TODO: let's fork this to mks org later
    - role: geerlingguy.docker
  tasks:
    - name: Create MKS directory if it does not exist
      ansible.builtin.file:
        path: /home/ubuntu/mks
        state: directory
        mode: '0755'

    - name: Recursively remove MKS sources directory
      ansible.builtin.file:
        path: /home/ubuntu/mks/sources
        state: absent

    - name: Create MKS sources directory if it does not exist
      ansible.builtin.file:
        path: /home/ubuntu/mks/sources
        state: directory
        mode: '0755'

    - name: Create MKS deploy directory if it does not exist
      ansible.builtin.file:
        path: /home/ubuntu/mks/deploy
        state: directory
        mode: '0755'

    - name: Create MKS storage folder (it has to be external VM drive)
      ansible.builtin.file:
        path: /home/ubuntu/mks/deploy/storage
        state: directory
        mode: '0755'

    # TODO: we have to add external drive via terraform and mount it to mks/deploy/storage

    - name: Clone a github repository
      git:
        repo: https://github.com/nochlezhka/mks.git
        dest: /home/ubuntu/mks/sources
        clone: yes
        update: yes
        version: "{{ mks_version }}"

    - name: Copy docker-compose file
      ansible.builtin.copy:
        src: /home/ubuntu/mks/sources/docker-compose.yml
        dest: /home/ubuntu/mks/deploy/docker-compose.yml
        remote_src: yes

    - name: Copy .env.dist => .env
      ansible.builtin.copy:
        src: /home/ubuntu/mks/sources/.env.dist
        dest: /home/ubuntu/mks/deploy/.env
        remote_src: yes

    # TODO: change these vars MYSQL_PASSWORD, MYSQL_ROOT_PASSWORD, DB_PASSWORD

    - name: Deploy a new version of MKS
      ansible.builtin.shell: |
        cd /home/ubuntu/mks/deploy
        export MKS_VERSION={{ mks_version | replace("/", "-") }}
        docker-compose --profile=local up -d --no-build

    - name: Execute migrations
      ansible.builtin.shell: |
        cd /home/ubuntu/mks/deploy
        docker-compose exec php ./app/console doctrine:migrations:migrate --no-interaction

    - name: Change admin password
      ansible.builtin.shell: |
        cd /home/ubuntu/mks/deploy
        # TODO
        # docker-compose exec php ./app/console fos:user:change-password admin